<!DOCTYPE html>
<html lang="en-US">

<head>

<title>MenuDrop</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  padding: 0 24px;
  color: #ffffff;
  background: url("https://www.lefthudson.com/wp-content/uploads/2019/11/sedona-wallpaper-awesome-gallery-sedona-real-inn-amp-suites-ideas-of-sedona-wallpaper.png") no-repeat center;
}
</style>

<template id="menu_styles">

<style>
:host(menu-drop), *, *::before, *::after {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
:host(menu-drop) {
  position: relative;/*position: fixed;right: 0;top: 0;*/
  display: inline-block;
  color: #000000;
  font-size: 13px;
  font-family: system-ui;//font-family: sans-serif;
  white-space: pre;
  user-select: none;
  -webkit-user-select: none;
  -webkit-app-region: no-drag;
}
[part="container"] {
  display: flex;
  flex-direction: column;
}
[part="opener"] {
  padding: 4px 8px;
  font-size: inherit;
  font-family: inherit;
  background: #bbbbbb;
  border: none;
  border-radius: 4px;
}
[part="list"] {
  padding: 8px 8px;
  position: absolute;
  --list-position-x: 0;
  top: 100%;
  list-style: none;
  --list-background: #ffffff80;
  --list-border-width: 1px;
  --list-border-color: #00000040;
  border: var(--list-border-width) solid transparent;
  border-radius: 6px;
  box-shadow: 0 5px 10px #00000060;
  visibility: hidden;
  opacity: 0;
  z-index: 1;
  transition: 100ms linear;
  transition-property: visibility, opacity;
}
[part="list"]::before {
  content: "";
  position: absolute;
  left: calc(var(--list-border-width) * -1);
  right: calc(var(--list-border-width) * -1);
  top: calc(var(--list-border-width) * -1);
  bottom: calc(var(--list-border-width) * -1);
  background: var(--list-background);
  backdrop-filter: blur(40px);
  -webkit-backdrop-filter: blur(40px);
  border: var(--list-border-width) solid var(--list-border-color);
  border-radius: inherit;
  pointer-events: none;
  z-index: -1;
}
:host(menu-drop[active]) [part="container"] > [part="list"] {
  visibility: visible;
  opacity: 1;
  transition-duration: 0ms;
}
[part="list-item"] {
  padding: 4px 8px;
  display: flex;
  gap: 24px;
  align-items: center;
  border-radius: 4px;
}
[part="list-item"]:-webkit-any(:hover,:focus-visible) {
  color: #eeeeee;
  background: #0763d5;
}
[part="shortcut"] {
  margin-left: auto;
  opacity: 0.6;
  pointer-events: none;
}
[part="list-item"]:-webkit-any(:hover,:focus-visible) [part="shortcut"] {
  opacity: 1;
}
[part="sub-list-container"] {
  position: relative;
}
[part="divider"] {
  margin: 6px 12px;
  border: none;
  border-top: 1px solid currentColor;
  opacity: 0.6;
}
[part="sub-list-container"] [part="list"] {
  --list-position-x: calc(100% - var(--list-horizontal-offset,0px));
  top: -9px;
}
[part="sub-list-container"][active] > [part="list"] {
  visibility: visible;
  opacity: 1;
  transition-duration: 0ms;
}
[part="sub-list-container"] > [part="list-item"]::after {
  content: "";
  margin-left: auto;
  border: 5px solid transparent;
  border-left-width: 6px;
  border-left-color: currentColor;
  border-right: none;
  opacity: 0.6;
}
[part="sub-list-container"] > [part="list-item"]:-webkit-any(:hover,:focus-visible)::after {
  opacity: 1;
}
[part="sub-list-container"]:-webkit-any(:hover,:focus-within,[active]) > [part="list-item"]:not(:hover):not(:focus-within) {
  --sub-list-item-active-background: #00000030;
  background: var(--sub-list-item-active-background);
}
[part="sub-list-container"]:-webkit-any(:hover,:focus-within,[active]) > [part="list-item"]:not(:hover):not(:focus-within)::after {
  opacity: 1;
}
</style>

</template>

<style>
/* Dark Mode testing styles */
:root.dark-mode menu-drop {
  color: #dddddd;
}
:root.dark-mode menu-drop::part(list) {
  --list-background: #24242490;
  --list-border-color: #ffffff30;
}
:root.dark-mode menu-drop::part(list-item) {
  --sub-list-item-active-background: #ffffff20;
}

/* Windows theme testing styles */
:root.windows menu-drop::part(list) {
  padding: 8px 0;
  --list-horizontal-offset: 5px;
  --list-border-color: transparent;
  border-radius: 0;
}
:root.windows menu-drop::part(list-item) {
  padding: 4px 20px;
  border-radius: 0;
}
</style>

<style>
pre {
  display: flex;
}
#source {
  margin-top: 130px;
  color: #000000;
  background: #ffffff;
}
</style>

</head>

<body>

<h1>MenuDrop</h1>

<nav>

<menu-drop active>
{
  "type": "opener",
  "label": "JSON-based menu"
},
{
  "type": "list",
  "content": [
    {
      "type": "list",
      "label": "A nice submenu",
      "content": [
        {
          "type": "list-item",
          "label": "JSON is cool",
          "shortcuts": {
            "default": "Ctrl + Shift + 1"
          }
        },
        {
          "type": "list-item",
          "label": "woah fancy"
        }
      ]
    },
    {
      "type": "list-item",
      "label": "noice list"
    },
    {
      "type": "list-item",
      "label": "Option 2",
      "shortcuts": {
        "default": "Ctrl + Shift + 2"
      }
    },
    {
      "type": "divider"
    },
    {
      "type": "list",
      "label": "dropdowndropdown",
    "active": true,
      "content": [
        {
          "type": "list",
          "label": "dropdowndropdown",
    "active": true,
          "content": [
            {
              "type": "list-item",
              "label": "goes on for a long time"
            },
            {
              "type": "list",
              "label": "dropdowndropdown",
    "active": true,
              "content": [
                {
                  "type": "list-item",
                  "label": "goes on for a long time"
                },
                {
                  "type": "list",
                  "label": "dropdowndropdown",
                  "content": [
                    {
                      "type": "list-item",
                      "label": "goes on for a long time"
                    },
                    {
                      "type": "list",
                      "label": "dropdowndropdown",
                      "content": [
                        {
                          "type": "list-item",
                          "label": "goes on for a long time"
                        },
                        {
                          "type": "list",
                          "label": "dropdowndropdown",
                          "content": [
                            {
                              "type": "list-item",
                              "label": "goes on for a long time"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "type": "list-item",
          "label": "gibberish words"
        },
        {
          "type": "list-item",
          "label": "content to help test things"
        }
      ]
    },
    {
      "type": "list-item",
      "label": "Really long name for testing"
    },
    {
      "type": "list-item",
      "label": "Better responsiveness!"
    }
  ]
}
</menu-drop>

<button onclick="event.stopPropagation();toggleDark();">Toggle Dark Mode</button>
<button onclick="event.stopPropagation();toggleOSTheme();">Toggle Windows/macOS</button>

</nav>

<textarea id="textarea"></textarea>
<button>Another element for testing z-index</button>

<pre>
  <code id="source"></code>
</pre>

<script>//console.clear();
class MenuDrop extends HTMLElement {
  constructor(){
    super();
    this.attachShadow({ mode: "open" });
  }
  connectedCallback(){
    this.styles = document.createElement("style");
    this.styles.textContent = menu_styles.content.querySelector("style").textContent;
    this.container = document.createElement("div");
    this.container.part = "container";

    this.layout = JSON.parse(`[${this.textContent}]`);

    this.opener = document.createElement("button");
    this.opener.part = "opener";
    this.opener.textContent = this.layout.find(element => (element.type == "opener")).label || "";
    this.opener.addEventListener("click",() => {
      (!this.active) ? this.open() : this.close();
    });

    this.list = document.createElement("ul");
    this.list.part = "list";
    this.list.setAttribute("content",JSON.stringify(this.layout.find(element => (element.type == "list")).content));

    this.list.addEventListener("click",event => {
      if (event.target.matches("[part='list'] > [part='list-item']")) this.close();
      if (event.target.matches("[part='sub-list-container'] > [part='list-item']")){
        var subListContainer = event.target.closest("[part='sub-list-container']");
        (!subListContainer.hasAttribute("active")) ? (() => { subListContainer.setAttribute("active",true); openList(subListContainer.querySelector("[part='list']"));}) : subListContainer.removeAttribute("active");
      }
    });

    this.shadowRoot.appendChild(this.container);
    this.container.appendChild(this.styles);

    this.container.appendChild(this.opener);
    this.container.appendChild(this.list);

    this.build_list(this.list);
    if (this.active) openList(this.list);

    var openerWidth = window.getComputedStyle(this.opener).getPropertyValue("width"),
      listWidth = window.getComputedStyle(this.list).getPropertyValue("width");
    // For <select>-like styling //if (openerWidth < listWidth) this.opener.style.width = listWidth;
    if (openerWidth > listWidth) this.list.style.width = openerWidth;

    //this.container.innerHTML += JSON.stringify(this.layout,null,"  ");
    //textarea.value = this.container.outerHTML;
    //this.container.querySelectorAll("[content]").forEach(element => element.removeAttribute("content"));
    //source.textContent = this.list.outerHTML.split("><").join(">\n<");
  }
  build_list(list){
    var content = JSON.parse(list.getAttribute("content"));
    list.addEventListener("mouseover",event => {
      if (!event.target.matches("[part='list-item']")) return;
      list.querySelectorAll("[part='sub-list-container'][active]").forEach(itemContainer => {
        itemContainer.removeAttribute("active");
      });
      if (!event.target.matches("[part='sub-list-container'] > [part='list-item']")) return;
      event.target.parentElement.setAttribute("active",true);
      openList(event.target.parentElement.querySelector("[part='list']"));
    });
    list.addEventListener("mouseout",event => {
      if (event.target == list) return;
      //source.textContent = event.target.cloneNode().outerHTML.split("><").join(`>${event.target.childNodes[0].textContent}<`);
      list.querySelectorAll("[part='sub-list-container'][active]").forEach(itemContainer => {
        itemContainer.removeAttribute("active");
      });
    });

    content.forEach(element => {
      if (element.type == "divider"){
        var divider = document.createElement("hr");
        divider.part = "divider";
        list.appendChild(divider);
        return;
      }
      var itemContainer;
      if (element.type == "list"){
        itemContainer = document.createElement("div");
        itemContainer.part = "sub-list-container";
        if (element.active) itemContainer.setAttribute("active",true);
      }
      var listItem = document.createElement("li");
      listItem.part = "list-item";
      listItem.tabIndex = 0;
      listItem.textContent = element.label;
      if (element.shortcuts && !itemContainer){
        var shortcut = document.createElement("span");
        shortcut.part = "shortcut";
        shortcut.textContent = element.shortcuts.default;
        listItem.appendChild(shortcut);
      }
      var subList = document.createElement("ul");
      subList.part = "list";


      if (itemContainer){
        subList.addEventListener("mouseover",event => {
          event.stopPropagation();
        });
        itemContainer.addEventListener("mouseout",event => {
          event.stopPropagation();
        });
        itemContainer.appendChild(listItem);
        list.appendChild(itemContainer);
        itemContainer.appendChild(subList);
        if (element.active) openList(subList);
      } else {
        list.appendChild(listItem);
      }


      if (element.type != "list") return;
      subList.setAttribute("content",JSON.stringify(element.content));
      this.build_list(subList);
    });
  }
  get active(){
    return this.hasAttribute("active");
  }
  open(){
    this.setAttribute("active",true);
    openList(this.list);
  }
  close(){//source.textContent = "";
    this.removeAttribute("active");
    this.container.querySelectorAll("[part='sub-list-container'][active]").forEach(subList => subList.removeAttribute("active"));
  }
}
window.customElements.define("menu-drop",MenuDrop);

window.addEventListener("click",() => {
  if (event.target.closest("menu-drop")) return;
  document.querySelectorAll("menu-drop[active]").forEach(menuDrop => {
    menuDrop.close();
  });
});

window.addEventListener("resize",() => {
  var resizeIdentifier = Math.random().toString();
  document.documentElement.setAttribute("data-menu-resize-identifier",resizeIdentifier);
  window.setTimeout(() => {
    if (document.documentElement.getAttribute("data-menu-resize-identifier") != resizeIdentifier) return;
    document.querySelectorAll("menu-drop[active]").forEach(menuDrop => menuDrop.container.querySelectorAll("[active] > [part='list']").forEach(list => openList(list)));
    document.documentElement.removeAttribute("data-menu-resize-identifier");
  },200);
});

window.addEventListener("blur",() => {
  document.querySelectorAll("menu-drop[active]").forEach(menuDrop => {
    menuDrop.close();
  });
});

function openList(list){
  var inViewport = isInViewport(list.parentElement);
  list.removeAttribute("style");
  if (inViewport){
    list.style.left = "var(--list-position-x)";
  } else {
    list.style.right = "var(--list-position-x)";
  }

  return;/* Testing things */
  var sourceTemp = list.cloneNode();
  sourceTemp.removeAttribute("content");
  sourceTemp.textContent = list.parentElement.querySelector("[part='list-item']").textContent;
  source.textContent += `${sourceTemp.outerHTML}\n`;
}
function isInViewport(element){
  var bounds = element.getBoundingClientRect();
  return (bounds.left >= 0 && bounds.right <= window.innerWidth - bounds.width);
}
</script>

<script>
  //toggleDark();
  toggleOSTheme();
  function toggleDark(){
    document.documentElement.classList.toggle("dark-mode");
  }
  function toggleOSTheme(){
    document.documentElement.classList.toggle("windows");
  }
</script>

</body>

</html>